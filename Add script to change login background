#!/bin/bash

# Verificar que se ejecute como root
if [ "$EUID" -ne 0 ]; then
  echo "Por favor, ejecuta el script como root (o con sudo)."
  exit 1
fi

# Ajusta esta ruta a la que hayas encontrado
GDM_CONFIG_FILE="/usr/share/gnome-shell/theme/ubuntu.css"
BACKUP_FILE="/usr/share/gnome-shell/theme/ubuntu.css.bak"

CUSTOM_BACKGROUND_DIR="/usr/share/backgrounds/custom"
SYSTEM_BACKGROUND_DIR="/usr/share/backgrounds"

function select_image() {
  local selected_path
  if command -v zenity &>/dev/null; then
    selected_path=$(zenity --file-selection \
                           --title="Selecciona una imagen para la pantalla de login" \
                           --filename="$SYSTEM_BACKGROUND_DIR/" \
                           --file-filter="Imágenes | *.png *.jpg *.jpeg *.bmp *.tiff" \
                           --file-filter="Todos los archivos | *.*")
    if [ -z "$selected_path" ]; then
      echo "No se seleccionó ninguna imagen."
      exit 1
    fi
  else
    echo "Zenity no está instalado. Se usará selección manual."
    read -rp "Introduce la ruta completa de la imagen: " selected_path
    if [ -z "$selected_path" ]; then
      echo "No se introdujo ninguna ruta de imagen. Abortando."
      exit 1
    fi
  fi
  echo "$selected_path"
}

IMAGE_PATH="$(select_image)"

if [ ! -f "$IMAGE_PATH" ]; then
  echo "El archivo '$IMAGE_PATH' no existe. Abortando."
  exit 1
fi

mkdir -p "$CUSTOM_BACKGROUND_DIR"
cp "$IMAGE_PATH" "$CUSTOM_BACKGROUND_DIR/"

IMAGE_FILENAME=$(basename "$IMAGE_PATH")

if [ ! -f "$BACKUP_FILE" ]; then
  echo "Creando copia de seguridad en $BACKUP_FILE"
  cp "$GDM_CONFIG_FILE" "$BACKUP_FILE"
else
  echo "Ya existe una copia de seguridad en $BACKUP_FILE"
fi

# Eliminar referencias anteriores
sed -i '/#lockDialogGroup {/,/}/ {
  /background: url/d
  /background-size:/d
}' "$GDM_CONFIG_FILE"

# Insertar nueva referencia
sed -i "/#lockDialogGroup {/a\  background: url(file://$CUSTOM_BACKGROUND_DIR/$IMAGE_FILENAME);\n  background-size: cover;" "$GDM_CONFIG_FILE"

echo "====================================================="
echo "¡Fondo de pantalla de login actualizado con éxito!"
echo "Imagen seleccionada: $IMAGE_PATH"
echo "Se ha guardado una copia de seguridad en: $BACKUP_FILE"
echo "Para revertir, restaura manualmente ese archivo:"
echo "  sudo cp $BACKUP_FILE $GDM_CONFIG_FILE"
echo "====================================================="
